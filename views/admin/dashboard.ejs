<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/problems">
                            <i class="fas fa-code"></i> Problems
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/topics">
                            <i class="fas fa-book"></i> Topics
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

            <!-- Stats Cards -->
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        TOTAL USERS</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <%= stats.totalUsers %>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        TOTAL PROBLEMS</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <%= stats.totalProblems %>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-code fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        COMPANIES</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-building fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        ACTIVE USERS</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        <%= stats.totalUsers %>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Topic Card -->
            <div class="row mt-4">
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-body">
                            <h5 class="card-title">Add New Topic</h5>
                            <form id="addTopicForm">
                                <div class="mb-3">
                                    <label for="topicName" class="form-label">Topic Name</label>
                                    <input type="text" class="form-control" id="topicName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="difficulty" class="form-label">Difficulty Level</label>
                                    <select class="form-select" id="difficulty" name="difficulty" required>
                                        <option value="Easy">Easy</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="Hard">Hard</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Topic</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Topics List -->
                <div class="col-xl-8 col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Recent Topics</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Topic Name</th>
                                            <th>Difficulty</th>
                                            <th>Problems</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topicsTableBody">
                                        <% if (stats.topics && stats.topics.length > 0) { %>
                                            <% stats.topics.forEach(topic => { %>
                                                <tr>
                                                    <td><%= topic.name %></td>
                                                    <td><%= topic.difficulty %></td>
                                                    <td><%= topic.problemCount %></td>
                                                    <td><%= new Date(topic.createdAt).toLocaleDateString() %></td>
                                                    <td>
                                                        <button class="btn btn-danger btn-sm delete-topic" data-id="<%= topic._id %>">Delete</button>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="4" class="text-center">No topics found</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Problem Card -->
            <div class="row mt-4">
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-body">
                            <h5 class="card-title">Add New Problem</h5>
                            <form id="addProblemForm">
                                <div class="mb-3">
                                    <label for="topic" class="form-label">Select Topic</label>
                                    <select class="form-select" id="topic" name="topic" required>
                                        <option value="">Select a topic</option>
                                        <% stats.topics.forEach(topic => { %>
                                            <option value="<%= topic._id %>"><%= topic.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="problemName" class="form-label">Problem Name</label>
                                    <input type="text" class="form-control" id="problemName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="slug" class="form-label">Slug Name</label>
                                    <input type="text" class="form-control" id="slug" name="slug" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="leetcodeLink" class="form-label">LeetCode Link</label>
                                    <input type="url" class="form-control" id="leetcodeLink" name="leetcodeLink" required>
                                </div>
                                <div class="mb-3">
                                    <label for="difficulty" class="form-label">Difficulty Level</label>
                                    <select class="form-select" id="difficulty" name="difficulty" required>
                                        <option value="Easy">Easy</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Hard">Hard</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Problem</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Users Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Users</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (stats.recentUsers && stats.recentUsers.length > 0) { %>
                                    <% stats.recentUsers.forEach(user => { %>
                                        <tr>
                                            <td><%= user.name %></td>
                                            <td><%= user.email %></td>
                                            <td>
                                                <span class="badge bg-<%= user.isAdmin ? 'danger' : 'primary' %>">
                                                    <%= user.isAdmin ? 'Admin' : 'User' %>
                                                </span>
                                            </td>
                                            <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4" class="text-center">No users found</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
}

.sidebar .nav-link {
    font-weight: 500;
    color: #333;
}

.sidebar .nav-link.active {
    color: #007bff;
}

.sidebar .nav-link:hover {
    color: #007bff;
}

.sidebar .nav-link i {
    margin-right: 8px;
}

.border-left-primary {
    border-left: 4px solid #4e73df;
}

.border-left-success {
    border-left: 4px solid #1cc88a;
}

.border-left-info {
    border-left: 4px solid #36b9cc;
}

.border-left-warning {
    border-left: 4px solid #f6c23e;
}

@media (max-width: 767.98px) {
    .sidebar {
        position: static;
        padding-top: 0;
    }
}
</style>

<%- include('../partials/footer') %>

<script>
document.getElementById('addTopicForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('topicName').value,
        difficulty: document.getElementById('difficulty').value
    };

    try {
        const response = await fetch('/admin/topics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
            alert('Topic added successfully!');
            window.location.reload();
        } else {
            alert(data.error || 'Error adding topic');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding topic');
    }
});

// Delete topic functionality
document.querySelectorAll('.delete-topic').forEach(button => {
    button.addEventListener('click', async function() {
        if (confirm('Are you sure you want to delete this topic?')) {
            const topicId = this.dataset.id;
            try {
                const response = await fetch(`/admin/topics/${topicId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    this.closest('tr').remove();
                    alert('Topic deleted successfully');
                } else {
                    alert('Error deleting topic');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting topic');
            }
        }
    });
});

document.getElementById('problemName').addEventListener('input', function() {
    const problemName = this.value;
    const slug = problemName.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');
    document.getElementById('slug').value = slug;
});

document.getElementById('addProblemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        topic: document.getElementById('topic').value,
        name: document.getElementById('problemName').value,
        slug: document.getElementById('slug').value,
        leetcodeLink: document.getElementById('leetcodeLink').value,
        difficulty: document.getElementById('difficulty').value
    };

    try {
        const response = await fetch('/admin/problems', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
            alert('Problem added successfully!');
            window.location.reload();
        } else {
            alert(data.error || 'Error adding problem');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding problem');
    }
});
</script> 